!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class e{constructor(e,t,i,s={}){this.scene=e,this.camera=e.cameras.main,this.minZoom=void 0!==s.minZoom?s.minZoom:.5,this.maxZoom=void 0!==s.maxZoom?s.maxZoom:2,this.zoomStep=void 0!==s.zoomStep?s.zoomStep:.1,this.isDragging=!1,this.dragStart={x:0,y:0},this.cameraStart={x:0,y:0},this.spaceKey=e.input.keyboard?e.input.keyboard.addKey("SPACE"):null,this.setupCamera(t,i),this.setupZoom()}setupCamera(e,t){this.camera.setBounds(0,0,e,t),this.camera.setZoom(1),this.camera.centerOn(e/2,t/2)}setupZoom(){this.scene.input.on("wheel",((e,t,i,s)=>{const a=s>0?-.1:.1,r=Phaser.Math.Clamp(this.camera.zoom+a,.5,2),n=this.camera.getWorldPoint(e.x,e.y);this.camera.setZoom(r),this.camera.scrollX=n.x-e.x/r,this.camera.scrollY=n.y-e.y/r}))}zoomBy(e){const t=this.camera,i=Phaser.Math.Clamp(t.zoom+e,.5,2);t.setZoom(i)}startDrag(e){this.isDragging=!0,this.dragStart.x=e.x,this.dragStart.y=e.y,this.cameraStart.x=this.camera.scrollX,this.cameraStart.y=this.camera.scrollY}drag(e){if(!this.isDragging)return;const t=(this.dragStart.x-e.x)/this.camera.zoom,i=(this.dragStart.y-e.y)/this.camera.zoom;this.camera.setScroll(this.cameraStart.x+t,this.cameraStart.y+i)}endDrag(){this.isDragging=!1}getIsDragging(){return this.isDragging}screenToWorld(e,t){return this.camera.getWorldPoint(e,t)}}const t={tileSize:64,tilesetKey:"tileset",terrainData:[[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,2],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]],path:[{col:1,row:1},{col:25,row:1},{col:25,row:3},{col:25,row:6},{col:45,row:6}],hqPosition:{col:45,row:6}};class i{constructor(e,i={}){this.scene=e,this.tileSize=i.tileSize||t.tileSize,this.terrainData=i.terrainData||t.terrainData,this.path=i.path||t.path,this.tilesetKey=i.tilesetKey||t.tilesetKey,this.map=null,this.groundLayer=null,this.createMap()}getHQPosition(){return t.hqPosition}createMap(){this.map=this.scene.make.tilemap({data:this.terrainData,tileWidth:this.tileSize,tileHeight:this.tileSize});const e=this.map.addTilesetImage(this.tilesetKey);this.groundLayer=this.map.createLayer(0,e,0,0),this.groundLayer.forEachTile((e=>{switch(e.index){case 1:e.properties.buildable=!0,e.properties.walkable=!1,e.properties.hasTower=!1;break;case 2:e.properties.buildable=!1,e.properties.walkable=!0,e.properties.hasTower=!1;break;default:e.properties.buildable=!1,e.properties.walkable=!1,e.properties.hasTower=!1}}))}isBuildable(e){return e&&!0===e.properties.buildable&&!e.properties.hasTower}isRemovable(e){return e&&!0===e.properties.hasTower}getMapWidth(){return this.terrainData[0].length*this.tileSize}getMapHeight(){return this.terrainData.length*this.tileSize}getMapSize(){return{width:this.getMapWidth(),height:this.getMapHeight()}}pathToPixelPath(e){return e.map((e=>({x:e.col*this.tileSize+this.tileSize/2,y:e.row*this.tileSize+this.tileSize/2})))}getPixelPath(){return this.pathToPixelPath(this.path)}getTileAtWorldXY(e,t){return this.groundLayer.getTileAtWorldXY(e,t)}getTileAt(e,t){return this.groundLayer.getTileAt(e,t)}getGroundLayer(){return this.groundLayer}getTileSize(){return this.tileSize}getPath(){return this.path}}class s{constructor(e,t,i,s,a){this.scene=e,this.cameraController=t,this.mapManager=i,this.gameObjectManager=s,this.gameContext=a,this.pointerDownPos=null,this.isDragging=!1,this.activePointers=new Set,this.isPinching=!1,this.lastPinchDistance=0,this.setupInput()}setupInput(){this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointermove",this.onPointerMove,this),this.scene.input.on("pointerup",this.onPointerUp,this)}onPointerDown(e){if(this.activePointers.add(e.id),this.activePointers.size>=2)return this.isPinching=!0,void this.cameraController.endDrag();console.log("当前input：",this.scene.input),console.log("当前pointer触发了onPointerDown：",e),this.pointerDownPos={x:e.x,y:e.y},this.isDragging=!1}onPointerMove(e){if(this.isPinching)return void this.handlePinchZoom();if(!this.pointerDownPos)return;const t=!1===e.wasTouch?10:20,i=e.x-this.pointerDownPos.x,s=e.y-this.pointerDownPos.y,a=Math.sqrt(i*i+s*s);!this.isDragging&&a>t&&(this.isDragging=!0,this.cameraController.startDrag(e)),this.isDragging&&this.cameraController.drag(e)}onPointerUp(e){this.activePointers.delete(e.id),this.isPinching?this.activePointers.size<2&&(this.isPinching=!1,this.lastPinchDistance=0):(this.isDragging?this.cameraController.endDrag():this.handleClick(e),this.pointerDownPos=null,this.isDragging=!1)}handlePinchZoom(){const e=this.scene.input.pointers.filter((e=>e.isDown));if(e.length<2)return;const[t,i]=e,s=t.x-i.x,a=t.y-i.y,r=Math.hypot(s,a);if(0===this.lastPinchDistance)return void(this.lastPinchDistance=r);const n=r-this.lastPinchDistance;this.lastPinchDistance=r,this.cameraController.zoomBy(.002*n)}handleClick(e){const t=this.cameraController.screenToWorld(e.x,e.y),i=this.mapManager.getTileAtWorldXY(t.x,t.y);if(i)switch(this.gameContext.getBuildMode()){case 1:this.gameObjectManager.tryBuildTower(i),this.gameContext.setBuildMode(0);break;case 2:this.gameObjectManager.tryRemoveTower(i),this.gameContext.setBuildMode(0)}}}class a extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,s,a={}){super(e,t,i,s),e.add.existing(this),e.physics.add.existing(this),this.maxHp=a.maxHp||a.hp||100,this.hp=a.hp||this.maxHp,this.enableLogging=void 0!==a.enableLogging&&a.enableLogging,this.entityName=a.entityName||"Entity"}takeDamage(e){this.hp-=e,this.enableLogging&&console.log(`${this.entityName}受到伤害:`,e,"当前HP:",this.hp),this.hp<=0&&this.destroy()}heal(e){this.hp+=e,this.hp>this.maxHp&&(this.hp=this.maxHp),this.enableLogging&&console.log(`${this.entityName}恢复生命值:`,e,"当前HP:",this.hp)}setHp(e){this.hp=Phaser.Math.Clamp(e,0,this.maxHp)}setMaxHp(e){this.maxHp=e,this.hp>this.maxHp&&(this.hp=this.maxHp)}getHpPercent(){return this.maxHp>0?this.hp/this.maxHp:0}isAlive(){return this.hp>0&&this.active}}const r={hp:200,maxHp:200,range:150,fireRate:1e3,enableLogging:!0,entityName:"塔"},n={hp:100,maxHp:100,speed:100,damage:50,enableLogging:!1,entityName:"敌人"},h={hp:500,maxHp:500,health:5,fireRate:5e3,enableLogging:!0,entityName:"HQ"},o={speed:200,damage:25};class l extends a{constructor(e,t,i){const s=n;super(e,t[0].x,t[0].y,"enemy",{hp:s.hp,maxHp:s.maxHp,enableLogging:s.enableLogging,entityName:s.entityName}),this.hardlevel=i,this.spriteType=0,this.enemyType="basicEnemy",this.path=t,this.pathIndex=0,this.speed=s.speed,this.damage=s.damage}update(e,t){if(this.pathIndex<this.path.length-1){const e=this.path[this.pathIndex+1],i=e.x-this.x,s=e.y-this.y,a=Math.sqrt(i*i+s*s);a<5?this.pathIndex++:(this.x+=i/a*this.speed*(t/1e3),this.y+=s/a*this.speed*(t/1e3))}else this.destroy()}}class c{constructor(e,t,i,s={}){this.scene=e,this.mapManager=t,this.gameObjectManager=i,this.spawnDelay=s.spawnDelay||2e3,this.hardlevel=s.hardlevel||1,this.isSpawning=!1,this.spawnTimer=null}start(){this.isSpawning||(this.isSpawning=!0,this.spawnTimer=this.scene.time.addEvent({delay:this.spawnDelay,callback:()=>{this.spawnEnemy()},loop:!0}))}stop(){this.isSpawning&&(this.isSpawning=!1,this.spawnTimer&&(this.spawnTimer.remove(),this.spawnTimer=null))}spawnEnemy(){const e=this.mapManager.getPixelPath(),t=new l(this.scene,e,this.hardlevel);this.gameObjectManager.addEnemy(t)}setSpawnDelay(e){this.spawnDelay=e,this.isSpawning&&(this.stop(),this.start())}setHardlevel(e){this.hardlevel=e}getIsSpawning(){return this.isSpawning}spawnEnemyNow(){this.spawnEnemy()}}class g{constructor(e,t){this.scene=e,this.physics=t,this.collisions=[]}registerEnemyHQCollision(e,t,i){const s=this.physics.add.overlap(e,t,((e,t)=>{const s=0===e.spriteType?e:t,a=1===e.spriteType?e:t;i?i(s,a):this.handleEnemyHitHQ(s,a)}),null,this.scene);return this.collisions.push({type:"enemy-hq",collision:s}),s}registerBulletEnemyCollision(e,t,i){const s=this.physics.add.overlap(e,t,((e,t)=>{i?i(e,t):this.handleBulletHitEnemy(e,t)}),null,this.scene);return this.collisions.push({type:"bullet-enemy",collision:s}),s}registerCollision(e,t,i,s=null,a=null,r="custom"){const n=this.physics.add.overlap(e,t,i,s,a||this.scene);return this.collisions.push({type:r,collision:n}),n}handleEnemyHitHQ(e,t){t.takeDamage(e.damage),e.destroy()}handleBulletHitEnemy(e,t){t.takeDamage(e.damage),e.destroy()}removeCollision(e){this.collisions=this.collisions.filter((t=>t.type!==e||(t.collision&&"function"==typeof t.collision.remove&&t.collision.remove(),!1)))}removeAllCollisions(){this.collisions.forEach((e=>{e.collision&&"function"==typeof e.collision.remove&&e.collision.remove()})),this.collisions=[]}getCollisions(){return this.collisions}}class p extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,s){super(e,t,i,"bullet"),e.add.existing(this),e.physics.add.existing(this);const a=o;this.spriteType=2,this.bulletType="basicBullet",this.target=s,this.speed=a.speed,this.damage=a.damage}preUpdate(e,t){if(super.preUpdate(e,t),!this.target||!this.target.active)return void this.destroy();const i=this.target.x-this.x,s=this.target.y-this.y,a=Math.sqrt(i*i+s*s);a<5?(this.target.takeDamage(this.damage),this.destroy()):(this.x+=i/a*this.speed*(t/1e3),this.y+=s/a*this.speed*(t/1e3))}}class d extends a{constructor(e,t,i){const s=r;super(e,t,i,"tower",{hp:s.hp,maxHp:s.maxHp,enableLogging:s.enableLogging,entityName:s.entityName}),this.spriteType=1,this.buildType=0,this.scene=e,this.range=s.range,this.fireRate=s.fireRate,this.lastFired=0}update(e,t){if(e>this.lastFired+this.fireRate){const t=this.scene.gameObjectManager.getEnemyInRange(this.x,this.y,this.range);t&&(this.scene.gameObjectManager.createBullet(this.x,this.y,t),this.lastFired=e)}}}class m extends a{constructor(e,t,i){const s=h;super(e,t,i,"hq",{hp:s.hp,maxHp:s.maxHp,enableLogging:s.enableLogging,entityName:s.entityName}),this.setImmovable(!0),this.spriteType=1,this.buildType="hq",this.health=s.health,this.fireRate=s.fireRate,this.lastFired=0}update(e,t){e>this.lastFired+this.fireRate&&(this.hp<this.maxHp&&this.heal(this.health),this.lastFired=e)}}class u{constructor(e,t){this.scene=e,this.physics=t,this.enemies=t.add.group(),this.towers=[],this.bullets=t.add.group(),this.hq=null}createHQ(e,t){return this.hq&&(console.warn("HQ已经存在，将销毁旧的HQ"),this.hq.destroy()),this.hq=new m(this.scene,e,t),this.hq}getHQ(){return this.hq}addEnemy(e){return this.enemies.add(e),e}removeEnemy(e){e&&e.active&&e.destroy()}getEnemies(){return this.enemies}getActiveEnemies(){return this.enemies.getChildren().filter((e=>e&&e.active))}getEnemyInRange(e,t,i){return this.enemies.getChildren().find((s=>!(!s||!s.active)&&Phaser.Math.Distance.Between(e,t,s.x,s.y)<i))}getEnemiesInRange(e,t,i){return this.enemies.getChildren().filter((s=>!(!s||!s.active)&&Phaser.Math.Distance.Between(e,t,s.x,s.y)<i))}tryBuildTower(e){if(!e)return!1;if(e.properties.hasTower)return console.warn("该 Tile 已有防御塔"),!1;if(!e.properties.buildable)return console.warn("该 Tile 不可建造"),!1;const t=e.getCenterX(),i=e.getCenterY(),s=this.createTower(t,i);return e.properties.hasTower=!0,e.tower=s,!0}tryRemoveTower(e){return e&&e.tower?(this.removeTower(e.tower),e.properties.hasTower=!1,e.tower=null,!0):(console.warn("该 Tile 上没有防御塔"),!1)}addTower(e){return this.towers.push(e),e}createTower(e,t){const i=new d(this.scene,e,t);return this.addTower(i),i}removeTower(e){const t=this.towers.indexOf(e);-1!==t&&this.towers.splice(t,1),e&&e.active&&e.destroy()}getTowers(){return this.towers}getTowerAt(e,t,i=5){return this.towers.find((s=>!(!s||!s.active)&&Phaser.Math.Distance.Between(e,t,s.x,s.y)<i))}addBullet(e){return this.bullets.add(e),e}createBullet(e,t,i){const s=new p(this.scene,e,t,i);return this.addBullet(s),s}removeBullet(e){e&&e.active&&e.destroy()}getBullets(){return this.bullets}getActiveBullets(){return this.bullets.getChildren().filter((e=>e&&e.active))}update(e,t){this.enemies.children.iterate((i=>{i&&i.active&&"function"==typeof i.update&&i.update(e,t)})),this.towers.forEach((i=>{i&&i.active&&"function"==typeof i.update&&i.update(e,t)})),this.hq&&this.hq.active&&"function"==typeof this.hq.update&&this.hq.update(e,t)}clearAll(){this.enemies.clear(!0,!0),this.towers.forEach((e=>{e&&e.active&&e.destroy()})),this.towers=[],this.bullets.clear(!0,!0),this.hq&&this.hq.active&&this.hq.destroy(),this.hq=null}clearEnemies(){this.enemies.clear(!0,!0)}clearTowers(){this.towers.forEach((e=>{e&&e.active&&e.destroy()})),this.towers=[]}clearBullets(){this.bullets.clear(!0,!0)}getStats(){return{enemies:{total:this.enemies.getLength(),active:this.getActiveEnemies().length},towers:{total:this.towers.length,active:this.towers.filter((e=>e&&e.active)).length},bullets:{total:this.bullets.getLength(),active:this.getActiveBullets().length},hq:{exists:null!==this.hq,active:this.hq&&this.hq.active}}}}const y=2e3,w="../assets/Enemy/enemy.png",x="../assets/Tower/tower.png",b="../assets/Tower/bullet.png",v="../assets/Texture/tileset_combined.png",P="../assets/Texture/hq.png",T="../assets/UI/btn_build.png",f="../assets/UI/btn_remove.png";class M extends Phaser.Scene{constructor(e){super("GameScene"),this.gameContext=e,this.buildMode=this.gameContext.getBuildMode(),this.hardlevel=1}preload(){this.load.image("enemy",w),this.load.image("tower",x),this.load.image("bullet",b),this.load.image("tileset",v),this.load.image("hq",P)}create(){this.mapManager=new i(this);const t=this.mapManager.getMapSize();this.cameraController=new e(this,t.width,t.height),this.gameObjectManager=new u(this,this.physics);const a=this.mapManager.getHQPosition(),r=this.mapManager.getTileAt(a.col,a.row);this.gameObjectManager.createHQ(r.getCenterX(),r.getCenterY()),this.inputHandler=new s(this,this.cameraController,this.mapManager,this.gameObjectManager,this.gameContext),this.input.addPointer(1),this.collisionManager=new g(this,this.physics),this.collisionManager.registerEnemyHQCollision(this.gameObjectManager.getEnemies(),this.gameObjectManager.getHQ()),this.enemySpawner=new c(this,this.mapManager,this.gameObjectManager,{spawnDelay:y,hardlevel:this.hardlevel}),this.enemySpawner.start()}update(e,t){const i=this.gameObjectManager.getHQ();if(i&&i.hp<=0)return console.log("游戏结束！HQ被摧毁"),void this.scene.pause();this.gameObjectManager.update(e,t)}}class S extends Phaser.Scene{constructor(e){super({key:"UIScene",active:!0}),this.gameContext=e}preload(){this.load.image("btnBuild",T),this.load.image("btnRemove",f)}create(){this.add.image(this.cameras.main.width-100,80,"btnBuild").setInteractive().setScrollFactor(0).on("pointerdown",(()=>{console.log("选择建造模式"),this.gameContext.setBuildMode(1)})),this.add.image(this.cameras.main.width-100,160,"btnRemove").setInteractive().setScrollFactor(0).on("pointerdown",(()=>{console.log("选择拆除模式"),this.gameContext.setBuildMode(2)}))}}const D=new class{constructor(){this._buildMode=0,this._selectedTowerType=null,this._paused=!1}getBuildMode(){return this._buildMode}setBuildMode(e){this._buildMode=e}getSelectedTowerType(){return this._selectedTowerType}setSelectedTowerType(e){this._selectedTowerType=e}isPaused(){return this._paused}setPaused(e){this._paused=e}},H={type:Phaser.AUTO,width:1920,height:1080,backgroundColor:"#333",physics:{default:"arcade",arcade:{debug:!0}},scene:[new M(D),new S(D)]};new Phaser.Game(H);
